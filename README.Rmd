---
title: "param6"
output: github_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(param6)
library(distr6)
library(paradox)
library(microbenchmark)
```

## Why param6?

Multiple bottlenecks in `distr6` all led to the `ParameterSet` object, which has considerable problems. `param6` deals with this by making use of:

* `list` instead of `data.table`
* `set6` and `Rcpp` for speed of containedness checks
* Symbolic representation for increasing speed of support checks
* S3 for `prm` parameter objects
* Removing `ParameterSetCollections` in favour of prefixes and extraction

## paradox vs. distr6 vs. param6

Below are some benchmarks comparing key features of param6, distr6, and paradox.

### Construction times

param6 and paradox include separate parameter objects whereas distr6 does not, therefore these are separately compared and then together.

#### param6::prm vs paradox::ParamX

```{r}
microbenchmark(
  paradox = paradox::ParamDbl$new("a"),
  param6 = param6::prm("a", "reals")
)
```

#### param6::ParameterSet vs paradox::ParamSet vs distr6::ParameterSet

First without values (this isn't possible in distr6):
```{r}
microbenchmark(
  paradox = {
    ParamSet$new(list(
      ParamDbl$new("a")
    ))
  }, 
  distr6 = {
    distr6::ParameterSet$new(
      id = "a",
      support = set6::Reals$new(),
      value = 1
    )
  },
  param6 = {
    param6::ParameterSet$new(list(
      prm("a", "reals")
    )) 
  }
)
```
With values:
```{r}
microbenchmark(
  paradox = {
    ps <- ParamSet$new(list(
      ParamDbl$new("a")
    ))
    ps$values$a <- 1
  }, 
  distr6 = {
    distr6::ParameterSet$new(
      id = "a",
      support = set6::Reals$new(),
      value = 1
    )
  },
  param6 = {
    param6::ParameterSet$new(list(
      prm("a", "reals", 1)
    )) 
  }
)
```
### Getting and setting values

```{r}
paradox <- ParamSet$new(list(
  ParamDbl$new("a")
))
paradox$values$a <- 1

param6 <- param6::ParameterSet$new(list(
  prm("a", "reals", 1)
)) 

distr6 <- distr6::ParameterSet$new(
  id = "a",
  support = set6::Reals$new(),
  value = 1
)
```

Getting values:

```{r}
microbenchmark(
  paradox = paradox$values$a,
  distr6 = distr6$getParameterValue("a"),
  param6 = param6$values$a
)
```
And setting:

```{r}
vals = list(a = 2)
microbenchmark(
  paradox = {paradox$values = vals},
  distr6 = distr6$setParameterValue(lst = vals),
  param6 = {param6$values = vals}
)
```
### Parameter set collections

param6 removes the idea of a collection by instead embracing prefixes and extraction methods.

```{r}
paradox1 <- ParamSet$new(list(
  ParamDbl$new("a")
))
paradox1$values$a <- 1
paradox2 <- ParamSet$new(list(
  ParamDbl$new("b")
))
paradox2$values$b <- 2

param61 <- param6::ParameterSet$new(list(
  prm("a", "reals", 1)
)) 
param62 <- param6::ParameterSet$new(list(
  prm("b", "reals", 2)
)) 

distr61 <- distr6::ParameterSet$new(
  id = "a",
  support = set6::Reals$new(),
  value = 1
)
distr62 <- distr6::ParameterSet$new(
  id = "a",
  support = set6::Reals$new(),
  value = 2
)
```

```{r}
microbenchmark(
  paradox = ParamSetCollection$new(list(paradox1, paradox2)),
  distr6 = ParameterSetCollection$new(D1 = distr61, D2 = distr62),
  param6 = param6:::c.ParameterSet(param61, param62)
)
```
Rep is a nice extra feature for replicating a parameter set with identical properties. This isn't currently possible in paradox or distr6, benchmark below compare excluding full process and including.


```{r}
paradox <- lapply(lapply(1:100, function(i) ParamDbl$new(paste0("Pre", i, "__a"))), function(.x) ParamSet$new(list(.x)))

distr6 <- rep(list(distr6::ParameterSet$new(
  id = "a",
  support = set6::Reals$new(),
  value = 1
)), 100)
names(distr6) <- paste0("Pre__", 1:100)

microbenchmark(
  paradox = ParamSetCollection$new(paradox),
  distr6 = ParameterSetCollection$new(lst = distr6),
  param6 = param6:::rep.ParameterSet(param6, 100, "Pre")
)

microbenchmark(
  paradox = {
    paradox <- lapply(lapply(1:100, function(i) 
      ParamDbl$new(paste0("Pre", i, "__a"))), function(.x) ParamSet$new(list(.x)))
    ParamSetCollection$new(paradox)
  },
  distr6 = {
    distr6 <- rep(list(distr6::ParameterSet$new(
      id = "a",
      support = set6::Reals$new(),
      value = 1
    )), 100)
    names(distr6) <- paste0("Pre__", 1:100)
    ParameterSetCollection$new(lst = distr6)
  },
  param6 = {
    param6 <- param6::ParameterSet$new(list(
      prm("a", "reals", 1)))
    param6:::rep.ParameterSet(param6, 100, "Pre")
  }
)
```


## Going Forward

param6 provides a promising alternative to other parameter interfaces by embracing symbolic representation and C++. The examples above do not show the full range of features including transformations, dependencies, custom checks, and tag properties. The examples are also on minimal parameters, I have seen over 100x improvement on distr6, and this is only the beginning.

Next steps will include incorporating Rcpp fully in set6 for further speed improvements and then with param6.
